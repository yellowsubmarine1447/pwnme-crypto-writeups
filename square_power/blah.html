<p>The code generates a number <span class="math inline"><em>n</em> = <em>p</em><em>q</em></span>, where <span class="math inline"><em>p</em></span> and <span class="math inline"><em>q</em></span> are <span class="math inline">512</span>-bit primes, a random integer <span class="math inline">1 &lt; <em>k</em> &lt; <em>n</em></span> coprime to <span class="math inline"><em>n</em></span>, and sets <span class="math inline"><em>g</em> = 1 + <em>k</em><em>n</em></span>. Integers <span class="math inline">1 &lt; <em>a</em> &lt; <em>n</em></span> and <span class="math inline">1 &lt; <em>b</em> &lt; <em>n</em></span> are also generated, and the public keys <span class="math inline"><em>A</em></span> and <span class="math inline"><em>B</em></span> are calculated as: <br /><span class="math display"><em>A</em> = <em>g</em><sup><em>a</em></sup> mod <em>n</em><sup>2</sup></span><br /> <br /><span class="math display"><em>B</em> = <em>g</em><sup><em>b</em></sup> mod <em>n</em><sup>2</sup></span><br /></p>
<p>We are retured every variable up to this point (except <span class="math inline"><em>p</em></span> and <span class="math inline"><em>q</em></span>), and our goal is to calculate <span class="math inline"><em>g</em><sup><em>a</em><em>b</em></sup> mod <em>p</em></span> (as this is the secret key used to encrypt our flag).</p>
Note that the binomial theorem, for some integer <span class="math inline"><em>x</em></span>, gives us <br /><span class="math display">$$g^x = (1 + kn)^x = 1 + \begin{pmatrix}x1\end{pmatrix}kn + \begin{pmatrix}x2\end{pmatrix}k^2n^2 + \cdots + \begin{pmatrix}xx\end{pmatrix}k^xn^x.$$</span><br /> Importantly, since our public keys are calculated under <span class="math inline"> mod <em>n</em><sup>2</sup></span>, the terms multiplied with the powers <span class="math inline"><em>n</em><sup>2</sup>, <em>n</em><sup>3</sup>, …, <em>n</em><sup><em>x</em></sup></span> must all become <span class="math inline">0</span> under the modulus (since <span class="math inline"><em>n</em><sup><em>m</em></sup> = <em>n</em><sup>2</sup> ⋅ <em>n</em><sup><em>m</em> − 2</sup> ≡ 0 mod <em>n</em></span> for <span class="math inline"><em>m</em> ≥ 2</span>). Also note $
<p>= Thus:</p>
